<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deferred Deeplink – Web Fingerprint</title>
  <style>
    :root {
      --bg: #f5f5f5;
      --card-bg: #ffffff;
      --text: #1a1a1a;
      --text-secondary: #666666;
      --border: #e0e0e0;
      --accent: #0066cc;
      --accent-hover: #0052a3;
      --success: #2e7d32;
      --code-bg: #f8f8f8;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #1a1a1a;
        --card-bg: #2a2a2a;
        --text: #e0e0e0;
        --text-secondary: #999999;
        --border: #404040;
        --accent: #4da6ff;
        --accent-hover: #80bfff;
        --success: #66bb6a;
        --code-bg: #1e1e1e;
      }
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      padding: 24px;
      max-width: 800px;
      margin: 0 auto;
    }

    h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .subtitle {
      color: var(--text-secondary);
      margin-bottom: 24px;
      font-size: 14px;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }

    .card h2 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s;
    }

    .btn-primary {
      background: var(--accent);
      color: #ffffff;
    }

    .btn-primary:hover {
      background: var(--accent-hover);
    }

    .btn-secondary {
      background: var(--border);
      color: var(--text);
    }

    .btn-secondary:hover {
      opacity: 0.85;
    }

    .endpoint-row {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }

    .endpoint-row input {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      background: var(--code-bg);
      color: var(--text);
      font-family: 'SF Mono', Monaco, Consolas, monospace;
    }

    .json-output {
      background: var(--code-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      font-family: 'SF Mono', Monaco, Consolas, monospace;
      font-size: 12px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 500px;
      overflow-y: auto;
      color: var(--text);
      display: none;
    }

    .json-output.visible {
      display: block;
    }

    .status {
      margin-top: 12px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .status.success {
      color: var(--success);
    }

    .status.error {
      color: #d32f2f;
    }

    .signal-count {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .deeplink-result {
      margin-top: 12px;
      padding: 12px;
      background: var(--code-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-family: 'SF Mono', Monaco, Consolas, monospace;
      font-size: 13px;
      display: none;
    }

    .deeplink-result.visible {
      display: block;
    }
  </style>
</head>
<body>
  <h1>Deferred Deeplink – Web Fingerprint</h1>
  <p class="subtitle">
    Collects browser-side device signals for matching with native app fingerprints.
  </p>

  <div class="card">
    <h2>Collect Fingerprint</h2>
    <div class="actions">
      <button class="btn-primary" id="collectBtn">Collect Signals</button>
      <button class="btn-secondary" id="copyBtn" style="display:none;">Copy JSON</button>
    </div>
    <div class="signal-count" id="signalCount"></div>
    <div class="json-output" id="jsonOutput"></div>
  </div>

  <div class="card">
    <h2>Resolve Deeplink</h2>
    <div class="endpoint-row">
      <input type="text" id="endpointInput" placeholder="https://example.com/api/v1/deferred-deeplink" value="https://example.com/api/v1/deferred-deeplink">
      <button class="btn-primary" id="resolveBtn">Resolve</button>
    </div>
    <div class="status" id="resolveStatus"></div>
    <div class="deeplink-result" id="deeplinkResult"></div>
  </div>

  <script src="fingerprint.js" onerror="window._fpLoadError=true"></script>
  <script>
    const collectBtn = document.getElementById('collectBtn');
    const copyBtn = document.getElementById('copyBtn');
    const jsonOutput = document.getElementById('jsonOutput');
    const signalCount = document.getElementById('signalCount');
    const resolveBtn = document.getElementById('resolveBtn');
    const endpointInput = document.getElementById('endpointInput');
    const resolveStatus = document.getElementById('resolveStatus');
    const deeplinkResult = document.getElementById('deeplinkResult');

    let lastCollected = null;

    collectBtn.addEventListener('click', async () => {
      collectBtn.disabled = true;
      collectBtn.textContent = 'Collecting…';

      if (window._fpLoadError || typeof DeviceFingerprint === 'undefined') {
        jsonOutput.textContent = 'Error: fingerprint.js failed to load. Make sure it is in the same directory as index.html.';
        jsonOutput.classList.add('visible');
        collectBtn.textContent = 'Collect Signals';
        collectBtn.disabled = false;
        return;
      }

      try {
        const info = await DeviceFingerprint.collect();
        lastCollected = info;
        const json = JSON.stringify(info, null, 2);

        const count = Object.keys(info).length;
        signalCount.textContent = `${count} signals collected`;

        jsonOutput.textContent = json;
        jsonOutput.classList.add('visible');
        copyBtn.style.display = 'inline-block';
      } catch (err) {
        jsonOutput.textContent = 'Error: ' + err.message;
        jsonOutput.classList.add('visible');
      }

      collectBtn.textContent = 'Collect Signals';
      collectBtn.disabled = false;
    });

    copyBtn.addEventListener('click', () => {
      if (!lastCollected) return;
      const json = JSON.stringify(lastCollected, null, 2);
      navigator.clipboard.writeText(json).then(() => {
        copyBtn.textContent = 'Copied!';
        setTimeout(() => { copyBtn.textContent = 'Copy JSON'; }, 1500);
      });
    });

    resolveBtn.addEventListener('click', async () => {
      if (window._fpLoadError || typeof DeviceFingerprint === 'undefined') {
        resolveStatus.textContent = 'Error: fingerprint.js failed to load.';
        resolveStatus.className = 'status error';
        return;
      }

      const endpoint = endpointInput.value.trim();
      if (!endpoint) {
        resolveStatus.textContent = 'Please enter an endpoint URL.';
        resolveStatus.className = 'status error';
        return;
      }

      resolveBtn.disabled = true;
      resolveStatus.textContent = 'Sending fingerprint…';
      resolveStatus.className = 'status';
      deeplinkResult.classList.remove('visible');

      try {
        const deeplink = await DeviceFingerprint.resolve(endpoint);
        if (deeplink) {
          resolveStatus.textContent = 'Deeplink resolved!';
          resolveStatus.className = 'status success';
          deeplinkResult.textContent = deeplink;
          deeplinkResult.classList.add('visible');
        } else {
          resolveStatus.textContent = 'No deeplink returned (or request failed).';
          resolveStatus.className = 'status error';
        }
      } catch (err) {
        resolveStatus.textContent = 'Error: ' + err.message;
        resolveStatus.className = 'status error';
      }

      resolveBtn.disabled = false;
    });
  </script>
</body>
</html>
